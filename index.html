<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Protocol v21 Victory</title>
    <style>
        /* --- PRO ATHLETE THEME --- */
        :root { 
            --bg: #0f172a;        /* Midnight Navy */
            --card: #1e293b;      /* Dark Slate */
            --text: #f8fafc;      /* Ice White */
            --sub: #94a3b8;       /* Cool Grey */
            --active: #3b82f6;    /* Electric Blue */
            --gold: #fbbf24;      /* Victory Gold */
            --success: #10b981;   /* Green */
        }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 20px; padding-bottom: 260px; 
            text-align: center; 
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        header { margin-bottom: 20px; padding-top: 10px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .workout-switch { display: flex; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 4px; gap: 4px; }
        .switch-btn { 
            flex: 1; border: none; background: transparent; 
            color: var(--sub); padding: 8px 16px; font-weight: 700; 
            cursor: pointer; border-radius: 8px; transition: 0.3s; 
        }
        .switch-btn.active { background: var(--active); color: #fff; }
        
        #session-timer { font-family: monospace; font-size: 1.1rem; font-weight: 700; color: var(--active); }

        /* CARDS */
        #list { display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px; min-height: 300px; }
        .card { 
            background: var(--card); border-radius: 20px; padding: 24px; 
            border: 2px solid transparent; transition: 0.3s ease; 
            position: relative; text-align: left;
        }
        .card.active { 
            border-color: var(--active); background: #253045; 
            transform: scale(1.02); box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
            z-index: 10; 
        }

        /* CONTROLS */
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .ex-name { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; text-transform: uppercase; }
        
        .adjuster-group { display: flex; gap: 12px; }
        .adj-ui { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px; }
        .adj-label { font-size: 0.65rem; color: var(--sub); font-weight: 700; }
        .btn-adj { width: 28px; height: 28px; border: none; background: rgba(255,255,255,0.1); color: #fff; border-radius: 8px; font-size: 1.2rem; font-weight: 700; cursor: pointer; }
        .val-display { font-weight: 800; font-size: 1.1rem; min-width: 30px; text-align: center; }

        .stats-row { display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.8rem; color: var(--sub); font-weight: 600; text-transform: uppercase; }
        .stat-val { color: #fff; font-weight: 800; margin-left: 6px; }
        .stat-val.live { color: var(--active); }

        .track { display: flex; gap: 6px; height: 10px; width: 100%; margin-top: 10px; }
        .seg { flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; transition: 0.4s; }
        .seg.active { background: var(--active); box-shadow: 0 0 15px var(--active); transform: scaleY(1.3); }
        .seg.done { background: var(--success); }

        .set-logs { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
        .log-badge { font-size: 0.7rem; font-weight: 700; background: rgba(255,255,255,0.05); color: var(--sub); padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }

        /* COACH BUTTON */
        #actionBtn { 
            position: fixed; bottom: 30px; left: 20px; right: 20px; height: 100px; 
            background: var(--text); color: var(--bg); border: none; border-radius: 24px; 
            cursor: pointer; display: flex; flex-direction: row; align-items: center; justify-content: flex-start; 
            padding: 0 30px; gap: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 100;
            transition: transform 0.1s, background 0.3s;
        }
        #actionBtn:active { transform: scale(0.98); }
        .btn-icon-box { width: 50px; height: 50px; background: rgba(0,0,0,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .btn-icon-box svg { width: 60%; height: 60%; fill: currentColor; }
        .btn-text-box { display: flex; flex-direction: column; align-items: flex-start; text-align: left; }
        #btnMain { font-size: 1.6rem; font-weight: 900; letter-spacing: -0.5px; line-height: 1; text-transform: uppercase; }
        #btnSub { font-size: 0.85rem; font-weight: 600; opacity: 0.8; margin-top: 6px; }

        /* BUTTON STATES */
        .st-lift { background: var(--active) !important; color: #fff !important; }
        .st-rest { background: var(--card) !important; color: #fff !important; border: 2px solid var(--sub); }
        .st-gold { background: var(--gold) !important; color: #000 !important; box-shadow: 0 0 50px rgba(251, 191, 36, 0.4) !important; }

        /* VICTORY LAYER */
        #victory-layer { display: none; padding-top: 50px; animation: fadeIn 1s; }
        .victory-title { font-size: 2.5rem; font-weight: 900; font-style: italic; margin-bottom: 20px; color: var(--gold); }
        .victory-stat { font-size: 1.2rem; color: var(--sub); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .victory-val { color: #fff; font-weight: 800; font-size: 1.5rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <header id="main-header">
        <div class="top-bar">
            <div class="workout-switch">
                <button class="switch-btn active" id="btnA" onclick="switchWorkout('A')">WORKOUT A</button>
                <button class="switch-btn" id="btnB" onclick="switchWorkout('B')">WORKOUT B</button>
            </div>
            <div id="session-timer">00:00</div>
        </div>
    </header>

    <div id="list"></div>

    <div id="victory-layer">
        <div class="victory-title">WORKOUT<br>CONQUERED</div>
        <div class="victory-stat">Total Volume<br><span class="victory-val" id="vic-vol">0</span> LBS</div>
        <br>
        <div class="victory-stat">Total Time<br><span class="victory-val" id="vic-time">00:00</span></div>
        <p style="color:#64748b; margin-top:40px; font-size:0.8rem;">Data synced to cloud.</p>
    </div>

    <button id="actionBtn" onclick="handleAction()">
        <div class="btn-icon-box" id="btnIcon"></div>
        <div class="btn-text-box">
            <div id="btnMain">START</div>
            <div id="btnSub">Ready</div>
        </div>
    </button>

<script>
    // --- ICONS ---
    const ICONS = {
        UP: '<svg viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>',
        LIFT: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-5h2V5h-2v6zm4 5h-2v-2h2v2zm0-5h2V5h-2v6z"/></svg>',
        REST: '<svg viewBox="0 0 24 24"><path d="M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>',
        TROPHY: '<svg viewBox="0 0 24 24"><path d="M20.2 2H3.8c-1.1 0-2 .9-2 2s.9 2 2 2c0 .55.45 1 1 1s1-.45 1-1h12.4c0 .55.45 1 1 1s1-.45 1-1c1.1 0 2-.9 2-2s-.9-2-2-2zM19 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM5 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'
    };

    // --- CONFIG ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQa2DcUfTAzmszUb02lB4dgneZvZpurgZszpl_NReTCD6ExcIrPtm_Y_yHhuviilqU/exec"; 

    // --- DEFAULTS ---
    const DEFAULT_A = [
        { name: "Squat", w: 75, sets: 5, reps: 5, cue: "Knees out. Chest up.", rest: "Walk it off." },
        { name: "Bench Press", w: 85, sets: 5, reps: 5, cue: "Leg drive. Explode.", rest: "Open chest." },
        { name: "Barbell Row", w: 65, sets: 5, reps: 5, cue: "Flat back. Pull to hips.", rest: "Relax back." },
        { name: "Face Pulls", w: 20, sets: 3, reps: 12, cue: "Squeeze rear delts.", rest: "Deep breath." },
        { name: "Tri Pushdown", w: 30, sets: 3, reps: 12, cue: "Lock elbows.", rest: "Shake arms." }
    ];

    const DEFAULT_B = [
        { name: "Squat", w: 75, sets: 5, reps: 5, cue: "Knees out. Chest up.", rest: "Walk it off." },
        { name: "Overhead Press", w: 45, sets: 5, reps: 5, cue: "Squeeze glutes.", rest: "Shake shoulders." },
        { name: "Deadlift", w: 135, sets: 1, reps: 5, cue: "Drag bar up legs.", rest: "Deep breaths." },
        { name: "Chin Ups", w: 0, sets: 3, reps: 8, cue: "Chin over bar.", rest: "Shake arms." },
        { name: "Bicep Curls", w: 20, sets: 3, reps: 12, cue: "Squeeze at top.", rest: "Relax." }
    ];

    // Safety fallback: Deep clone defaults immediately
    var CURRENT_ROUTINE = JSON.parse(JSON.stringify(DEFAULT_A));
    var CURRENT_TYPE = 'A';

    // --- STATE ---
    var currentEx = 0;
    var currentSet = 0;
    var step = 0; 
    var sessionSecs = 0;
    var liftSecs = 0; 
    var liftInt = null;
    var restInt = null;
    var sessionTotalVol = 0;

    // --- INIT ---
    window.addEventListener('load', function() {
        // CLEAN BREAK: We use 'v21' keys now.
        try {
            var savedA = localStorage.getItem('protocol_v21_A');
            if(savedA) CURRENT_ROUTINE = JSON.parse(savedA);
        } catch(e) {}

        renderList();
        
        setInterval(function() {
            sessionSecs++;
            document.getElementById('session-timer').innerText = fmtTime(sessionSecs);
        }, 1000);

        highlightCard(0);
        updateBtn(0);
    });

    // --- LOGIC ---
    function handleAction() {
        if(document.getElementById('victory-layer').style.display === 'block') {
            // If in victory mode, button resets app
            if(confirm("Start new workout?")) location.reload();
            return;
        }

        var ex = CURRENT_ROUTINE[currentEx];

        if(step === 0) {
            // READY -> LIFT
            step = 1;
            document.getElementById('seg_'+currentEx+'_'+currentSet).className = "seg active";
            highlightCard(currentEx);
            setBtn("LIFTING...", ex.cue, "st-lift", "LIFT");

            liftSecs = 0;
            document.getElementById('time_'+currentEx).className = "stat-val live";
            liftInt = setInterval(function(){ 
                liftSecs++; 
                document.getElementById('time_'+currentEx).innerText = (ex.totalTime||0) + liftSecs + "s";
            }, 1000);

        } else if (step === 1) {
            // LIFT -> REST
            step = 2;
            clearInterval(liftInt);

            // Update Data
            ex.totalTime = (ex.totalTime || 0) + liftSecs;
            document.getElementById('time_'+currentEx).className = "stat-val";
            document.getElementById('time_'+currentEx).innerText = ex.totalTime + "s";

            var setVol = ex.w * ex.reps;
            ex.totalVol = (ex.totalVol || 0) + setVol;
            sessionTotalVol += setVol;
            document.getElementById('vol_'+currentEx).innerText = ex.totalVol.toLocaleString();
            
            // Log Badge
            var logDiv = document.getElementById('logs_'+currentEx);
            logDiv.innerHTML += `<div class="log-badge">S${currentSet+1} • ${ex.w}lb • ${ex.reps}r</div>`;

            document.getElementById('seg_'+currentEx+'_'+currentSet).className = "seg done";
            
            // Sync & Save
            sendToCloud(ex.name, ex.w, ex.reps, liftSecs);
            saveLocal();
            
            startRest();

        } else if (step === 2) {
            // REST -> NEXT
            clearInterval(restInt);
            nextSet();
        }
    }

    function startRest() {
        var timeLeft = 90;
        var ex = CURRENT_ROUTINE[currentEx];
        setBtn("RESTING 01:30", ex.rest, "st-rest", "REST");
        
        restInt = setInterval(function() {
            timeLeft--;
            setBtn("RESTING " + fmtTime(timeLeft), ex.rest, "st-rest", "REST");
            if(timeLeft <= 0) {
                clearInterval(restInt);
                nextSet();
            }
        }, 1000);
    }

    function nextSet() {
        currentSet++;
        if(currentSet >= CURRENT_ROUTINE[currentEx].sets) {
            currentSet = 0;
            currentEx++;
        }

        if(currentEx >= CURRENT_ROUTINE.length) {
            triggerVictory();
            return;
        }

        step = 0;
        highlightCard(currentEx);
        updateBtn(currentEx);
    }

    function triggerVictory() {
        // Hide List, Show Victory
        document.getElementById('list').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('victory-layer').style.display = 'block';

        // Populate Stats
        document.getElementById('vic-vol').innerText = sessionTotalVol.toLocaleString();
        document.getElementById('vic-time').innerText = fmtTime(sessionSecs);

        // Gold Button
        setBtn("GREAT JOB", "Tap to Finish", "st-gold", "TROPHY");
    }

    // --- HELPERS ---
    function updateBtn(idx) {
        var ex = CURRENT_ROUTINE[idx];
        setBtn("START SET " + (currentSet+1), "GOAL: " + ex.reps + " REPS @ " + ex.w + " LBS", "", "UP");
    }

    function setBtn(main, sub, cls, iconKey) {
        var btn = document.getElementById('actionBtn');
        if(!btn) return;
        btn.className = cls || "";
        document.getElementById('btnMain').innerText = main;
        document.getElementById('btnSub').innerText = sub;
        document.getElementById('btnIcon').innerHTML = ICONS[iconKey];
    }

    function modWeight(idx, amount) {
        CURRENT_ROUTINE[idx].w += amount;
        if(CURRENT_ROUTINE[idx].w < 0) CURRENT_ROUTINE[idx].w = 0;
        document.getElementById('w_'+idx).innerText = CURRENT_ROUTINE[idx].w;
        if(idx === currentEx && step === 0) updateBtn(idx);
    }

    function modReps(idx, amount) {
        CURRENT_ROUTINE[idx].reps += amount;
        if(CURRENT_ROUTINE[idx].reps < 0) CURRENT_ROUTINE[idx].reps = 0;
        document.getElementById('r_'+idx).innerText = CURRENT_ROUTINE[idx].reps;
        if(idx === currentEx && step === 0) updateBtn(idx);
    }

    function highlightCard(idx) {
        var cards = document.querySelectorAll('.card');
        for(var i=0; i<cards.length; i++) cards[i].classList.remove('active');
        var c = document.getElementById('card_'+idx);
        if(c) {
            c.classList.add('active');
            c.scrollIntoView({behavior:'smooth', block:'center'});
        }
    }

    function fmtTime(s) {
        var m = Math.floor(s/60).toString().padStart(2,'0');
        var sc = (s%60).toString().padStart(2,'0');
        return m + ":" + sc;
    }

    // --- DATA ---
    function saveLocal() {
        if(CURRENT_TYPE === 'A') localStorage.setItem('protocol_v21_A', JSON.stringify(CURRENT_ROUTINE));
        else localStorage.setItem('protocol_v21_B', JSON.stringify(CURRENT_ROUTINE));
    }

    function sendToCloud(exName, weight, reps, time) {
        // The Magic Fix: URLSearchParams implies application/x-www-form-urlencoded
        var formData = new URLSearchParams();
        formData.append('timestamp', new Date().toLocaleString());
        formData.append('workout', CURRENT_TYPE);
        formData.append('exercise', exName);
        formData.append('weight', weight);
        formData.append('reps', reps);
        formData.append('time', time);

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        });
    }
    
    // Reset function for switcher
    window.switchWorkout = function(type) {
        if(confirm("Switch workout? Progress will reset.")) {
            CURRENT_TYPE = type;
            if(type === 'A') {
                CURRENT_ROUTINE = JSON.parse(JSON.stringify(DEFAULT_A));
                try {
                     var saved = localStorage.getItem('protocol_v21_A');
                     if(saved) CURRENT_ROUTINE = JSON.parse(saved);
                } catch(e) {}
                document.getElementById('btnA').classList.add('active');
                document.getElementById('btnB').classList.remove('active');
            } else {
                CURRENT_ROUTINE = JSON.parse(JSON.stringify(DEFAULT_B));
                try {
                     var saved = localStorage.getItem('protocol_v21_B');
                     if(saved) CURRENT_ROUTINE = JSON.parse(saved);
                } catch(e) {}
                document.getElementById('btnB').classList.add('active');
                document.getElementById('btnA').classList.remove('active');
            }
            // Reset
            currentEx = 0; currentSet = 0; step = 0;
            renderList();
            highlightCard(0);
            updateBtn(0);
        }
    }

    function renderList() {
        var list = document.getElementById('list');
        list.innerHTML = "";
        
        for(var i=0; i<CURRENT_ROUTINE.length; i++) {
            var ex = CURRENT_ROUTINE[i];
            // Safety checks
            ex.totalVol = ex.totalVol || 0;
            ex.totalTime = ex.totalTime || 0;

            var bars = "";
            for(var b=0; b<ex.sets; b++) {
                bars += '<div class="seg" id="seg_'+i+'_'+b+'"></div>';
            }

            list.innerHTML += `
                <div class="card" id="card_${i}">
                    <div class="controls-row">
                        <div class="ex-name">${ex.name}</div>
                        <div class="adjuster-group">
                            <div class="adj-ui">
                                <span class="adj-label">LBS</span>
                                <button class="btn-adj" onclick="modWeight(${i}, -5)">−</button>
                                <span class="val-display" id="w_${i}">${ex.w}</span>
                                <button class="btn-adj" onclick="modWeight(${i}, 5)">+</button>
                            </div>
                            <div class="adj-ui">
                                <span class="adj-label">REPS</span>
                                <button class="btn-adj" onclick="modReps(${i}, -1)">−</button>
                                <span class="val-display" id="r_${i}">${ex.reps}</span>
                                <button class="btn-adj" onclick="modReps(${i}, 1)">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <span>VOL <span class="stat-val" id="vol_${i}">${ex.totalVol.toLocaleString()}</span></span>
                        <span>TIME <span class="stat-val" id="time_${i}">${ex.totalTime}s</span></span>
                    </div>

                    <div class="track">${bars}</div>
                    <div class="set-logs" id="logs_${i}"></div>
                </div>
            `;
        }
    }
</script>
</body>
</html>
